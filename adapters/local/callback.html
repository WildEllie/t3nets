<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T3nets — Signing In...</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .callback-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .brand span {
            font-size: 28px;
            font-weight: 800;
            color: #fff;
        }

        .status {
            margin-top: 24px;
            font-size: 14px;
            color: #888;
        }

        .spinner {
            margin: 24px auto;
            width: 32px;
            height: 32px;
            border: 3px solid #333;
            border-top-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-msg {
            background: #7f1d1d;
            border: 1px solid #991b1b;
            color: #fecaca;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            margin-top: 16px;
            display: none;
        }

        .back-link {
            display: inline-block;
            margin-top: 16px;
            color: #3b82f6;
            text-decoration: none;
            font-size: 13px;
        }

        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="callback-card">
        <div class="brand">
            <span>T3nets</span>
        </div>

        <div class="spinner" id="spinner"></div>
        <div class="status" id="status">Completing sign in...</div>
        <div id="error-msg" class="error-msg"></div>
        <a href="/login" class="back-link" id="back-link" style="display:none;">Back to login</a>
    </div>

    <script>
        async function handleCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            const errorDesc = params.get('error_description');

            if (error) {
                showError(errorDesc || error);
                return;
            }

            if (!code) {
                showError('No authorization code received.');
                return;
            }

            try {
                // Load auth config to get Cognito details
                const configResp = await fetch('/api/auth/config');
                const config = await configResp.json();

                if (!config.enabled) {
                    // No Cognito — just redirect to chat
                    window.location.href = '/chat';
                    return;
                }

                // Exchange authorization code for tokens via Cognito token endpoint
                const tokenUrl = `${config.auth_domain}/oauth2/token`;
                const redirectUri = window.location.origin + '/callback';

                const body = new URLSearchParams({
                    grant_type: 'authorization_code',
                    client_id: config.client_id,
                    code: code,
                    redirect_uri: redirectUri,
                });

                const tokenResp = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: body.toString(),
                });

                if (!tokenResp.ok) {
                    const errData = await tokenResp.json().catch(() => ({}));
                    throw new Error(errData.error_description || errData.error || 'Token exchange failed');
                }

                const tokens = await tokenResp.json();

                // Store tokens in localStorage
                localStorage.setItem('t3nets_id_token', tokens.id_token);
                localStorage.setItem('t3nets_access_token', tokens.access_token);
                if (tokens.refresh_token) {
                    localStorage.setItem('t3nets_refresh_token', tokens.refresh_token);
                }

                document.getElementById('status').textContent = 'Success! Redirecting...';
                setTimeout(() => { window.location.href = '/chat'; }, 500);
            } catch (e) {
                showError('Sign in failed: ' + e.message);
            }
        }

        function showError(msg) {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            const errEl = document.getElementById('error-msg');
            errEl.textContent = msg;
            errEl.style.display = 'block';
            document.getElementById('back-link').style.display = 'inline-block';
        }

        handleCallback();
    </script>
</body>
</html>
